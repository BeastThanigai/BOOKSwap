<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishlist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>/*
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            position: absolute;
            top:70px;
            left:245px;
        }
    h1{
        margin-top: 2px;
    }
        #wishlist-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
        }
    
        .wishlist-card {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 400px; 
}
    
        .wishlist-image img {
    width: 100%;
    height: 200px; 
    object-fit: cover; 
    border-bottom: 1px solid #ccc;
}
    
        .wishlist-details {
            padding: 15px;
        }
    
        .wishlist-actions {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
    
        .wishlist-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    
        .view-more {
            background-color: #007bff;
            color: white;
        }
    
        .exchange-btn {
            background-color: #28a745;
            color: white;
        }
    
        .remove-btn {
            background-color: #dc3545;
            color: white;
        }
    
        #popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
    
        #popup-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            text-align: center;
        }
    
        #popup-content h3 {
            margin: 0 0 10px;
        }
    
        #popup-content p {
            margin: 5px 0;
        }
    
        #popup-content button {
            margin-top: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }*/
        body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    position: absolute;
    top: 70px;
    left: 180px; /* Moved leftwards */
}

h1 {
    margin-top: 2px;
    text-align: center;
}

#wishlist-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px; /* Slightly reduced gap */
    padding: 15px;
}

.wishlist-card {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 280px; /* Adjusted width */
    height: 360px; /* Reduced height */
    background: #fff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    transition: transform 0.3s ease-in-out;
}

.wishlist-card:hover {
    transform: scale(1.02);
}

.wishlist-image img {
    width: 100%;
    height: 180px; /* Reduced image height */
    object-fit: cover;
    border-bottom: 1px solid #ccc;
    border-radius: 8px 8px 0 0;
}

.wishlist-details {
    padding: 12px;
}

.wishlist-actions {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    gap: 8px;
}

.wishlist-actions button {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.2s ease;
}

/* Hover Effects */
.view-more {
    background-color: #007bff;
    color: white;
}
.view-more:hover {
    background-color: #0056b3;
    transform: scale(1.05);
}

.exchange-btn {
    background-color: #28a745;
    color: white;
}
.exchange-btn:hover {
    background-color: #218838;
    transform: scale(1.05);
}

.remove-btn {
    background-color: #dc3545;
    color: white;
}
.remove-btn:hover {
    background-color: #c82333;
    transform: scale(1.05);
}

#popup-overlay {
    display: none; /* Ensures it's hidden initially */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
}


#popup-content {
    background: white;
    padding: 15px;
    border-radius: 10px;
    width: 350px; /* Reduced width */
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

#popup-content h3 {
    margin: 0 0 10px;
}

#popup-content p {
    margin: 5px 0;
}

#popup-content button {
    margin-top: 10px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
#popup-content button:hover {
    background-color: #0056b3;
}

@media (max-width: 768px) {
    #wishlist-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Two boxes per row */
        gap: 2px; /* Adjust spacing between items */
        justify-content: center;
        padding: 8px;
        margin-left: -17%;
    }

    .wishlist-card {
        height: 350px; /* Reduce height slightly */
        padding: 10px;
    }

    .wishlist-image img {
        width: 100%;
        height: 180px; /* Slightly reduce image height */
        object-fit: cover;
        margin-left: -10px; /* Moves image slightly leftward */
    }

    .wishlist-actions {
        flex-wrap: wrap;
        gap: 5px;
    }

    .wishlist-actions button {
        font-size: 14px;
        padding: 8px;
    }

    /* Adjust popup size */
    #popup-content {
        width: 350px; /* Reduce popup width */
        padding: 15px;
    }
}

@media (max-width: 480px) {
    body {
        left: 20%; /* Reduce left spacing */
        top: 20px;
        padding: 5px; /* Reduce padding */
    }

    #wishlist-container {
        display: flex;
        flex-direction: column; /* Single column layout */
        align-items: center;
        padding: 10px;
        margin-left: 0; /* Reset unnecessary margin */
    }

    .wishlist-card {
        width: 99%; /* Increased width */
        height: 220px; /* Reduced height */
        padding: 8px;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .wishlist-image {
        text-align: center;
    }

    .wishlist-image img {
        height: 120px; /* Further reduce image height */
        width: 85%;
        object-fit: cover;
        display: block;
        margin: 0 auto;
    }

    .wishlist-details {
        padding: 5px;
        text-align: center;
    }

    .wishlist-details h3 {
        font-size: 13px; /* Adjust font size */
        margin-bottom: 3px;
    }

    .wishlist-details p {
        font-size: 11px; /* Adjust author font size */
        color: #555;
        margin: 2px 0;
    }

    .wishlist-actions {
        display: flex;
        justify-content: center;
        gap: 5px;
    }

    .wishlist-actions button {
        flex: 1;
        font-size: 11px;
        padding: 7px 5px;
        width: auto;
        white-space: nowrap;
    }

    .view-more, .exchange-btn, .remove-btn {
        width: 75px; /* Uniform width for all buttons */
        height: 32px; /* Uniform height */
    }

    /* Smaller, centered popup */
    #popup-overlay {
        justify-content: center;
        align-items: center;
    }

    #popup-content {
        width: 230px; /* Reduce popup width */
        padding: 10px;
        position: relative;
        left: 15px;
        top: 0;
        margin: auto;
    }
}



    </style>
</head>
<body>
    <h1>Your Wishlist</h1>
    <div class="wishlist-container" id="wishlist-container">
       
    </div>

   
    <div id="popup-overlay">
        <div id="popup-content">
            <h2 id="popup-title"></h2>
            <p id="popup-author"></p>
            <p id="popup-description"></p>
            <p id="popup-status"></p>
            <p id="popup-genre"></p>
            <button onclick="closePopup()">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, get, set, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { addNotification } from "./notification.js";

       
        const firebaseConfig = {
            apiKey: "AIzaSyD1wF844Xeur0bEDQfZdoydiNbcLdlStOU",
            authDomain: "bookexc.firebaseapp.com",
            databaseURL: "https://bookexc-default-rtdb.firebaseio.com",
            projectId: "bookexc",
            storageBucket: "bookexc.appspot.com",
            messagingSenderId: "688636268839",
            appId: "1:688636268839:web:abe81b13bc8bfa8ab01902",
            measurementId: "G-8TZ99T5M1L"
        };
    
             
             const app = initializeApp(firebaseConfig);
const db = getDatabase(app);



const params = new URLSearchParams(window.location.search);
const userId = params.get("userid");

if (!userId) {
    alert("User ID not found in the URL. Please log in again.");
}

const wishlistRef = ref(db, `wishlist/${userId}`);

function loadWishlist() {
    onValue(wishlistRef, (snapshot) => {
        const wishlistContainer = document.getElementById("wishlist-container");
        wishlistContainer.innerHTML = ""; // Clear the wishlist container

        if (snapshot.exists()) {
            const books = snapshot.val();
            Object.keys(books).forEach((key) => {
                const book = books[key];
                const bookItem = document.createElement("div");
                bookItem.className = "wishlist-card";
                bookItem.id = key;

                let base64Image = book.image || null;
                if (base64Image) {
                    if (!base64Image.startsWith("data:image/")) {
                        base64Image = `data:image/jpeg;base64,${base64Image}`;
                    }
                    renderWishlistItem(bookItem, book, base64Image, key);
                } else {
                    console.warn(`No image provided for book: ${book.title}`);
                    renderWishlistItem(bookItem, book, "imageBook/book7.jpg", key);
                }

                wishlistContainer.appendChild(bookItem);
            });
        } else {
            wishlistContainer.innerHTML = "<p>No books in your wishlist!</p>";
        }
    });
}

function renderWishlistItem(bookItem, book, imageUrl, key) {
    const wishlistID = key;
    const bookID = book.bookId || book.originalBookID; // Fetch correct book ID

    bookItem.innerHTML = `
        <div class="wishlist-image">
            <img src="${imageUrl}" alt="${book.title}" onerror="this.src='defaultImagePath/placeholder.jpg';">
        </div>
        <div class="wishlist-details">
            <h3>${book.title}</h3>
            <p><strong>Author:</strong> ${book.author || "Unknown"}</p>
            <div class="wishlist-actions">
                <button onclick='viewMore(${JSON.stringify(book)})' class="view-more">View More</button>
                <button class="exchange-btn" onclick="handleExchangeRequest('${bookID}', '${userId}')">Exchange Request</button>
                <button class="remove-btn" onclick="removeFromWishlist('${wishlistID}')">Remove</button>
            </div>
        </div>
    `;
}

window.viewMore = function (book) {
    document.getElementById("popup-title").innerText = `Title: ${book.title}`;
    document.getElementById("popup-author").innerText = `Author: ${book.author}`;
    document.getElementById("popup-description").innerText = `Description: ${book.description || 'No description available'}`;
    document.getElementById("popup-status").innerText = `Status: ${book.status || 'Not specified'}`;
    document.getElementById("popup-genre").innerText = `Genre: ${book.genre || 'Not specified'}`;
    document.getElementById("popup-overlay").style.display = "flex";
};

window.closePopup = function () {
    document.getElementById("popup-overlay").style.display = "none";
};
/*
window.handleExchangeRequest = function (bookID, userId) {
    if (!userId) {
        alert("You must be logged in to request an exchange.");
        return;
    }

    console.log("Requesting exchange for bookID:", bookID);

    const booksRef = ref(db, "books/"); 

    get(booksRef)
        .then((snapshot) => {
            if (!snapshot.exists()) {
                alert("No books found in the system.");
                return;
            }

            let foundBook = null;
            let bookKey = null; 
            let bookOwnerId = null;

            snapshot.forEach((childSnapshot) => {
                const bookData = childSnapshot.val();
                if (bookData.id === bookID) { 
                    foundBook = bookData;
                    bookKey = childSnapshot.key; // Get the actual key from Firebase
                    bookOwnerId = bookData.userid;
                }
            });

            if (!foundBook || !bookKey) {
                alert("Book not found in the system.");
                return;
            }

            if (!bookOwnerId) {
                alert("Error: Book owner not found.");
                return;
            }

            if (bookOwnerId === userId) {
                alert("You cannot exchange your own book.");
                return;
            }

            if (!foundBook.status || foundBook.status.toLowerCase() !== "available") {
                alert(`Sorry, "${foundBook.title}" is currently unavailable for exchange.`);
                return;
            }

            createExchangeRequest(bookKey, bookOwnerId, userId, foundBook.title);
        })
        .catch((error) => {
            console.error("Error fetching books:", error);
            alert("Failed to fetch book information.");
        });
};

function createExchangeRequest(bookKey, bookOwnerId, userId, bookTitle) {
    const requestID = generateUniqueID();

    Promise.all([
        get(ref(db, `profiles/${userId}`)),    // Requester's profile
        get(ref(db, `profiles/${bookOwnerId}`)) // Book owner's profile
    ]).then(([requestedBySnap, requestedToSnap]) => {
        const requestedByName = requestedBySnap.exists() ? requestedBySnap.val().name : "Unknown User";
        const requestedToName = requestedToSnap.exists() ? requestedToSnap.val().name : "Unknown User";

        const exchangeRef = ref(db, `exchange_requests/${requestID}`);

        set(exchangeRef, {
            requestID: requestID,
            requestedBy: requestedByName,
            requestedTo: requestedToName,
            bookRequested: bookKey, 
            status: "pending",
            bookHandover: "pending",
            bookReturn: "pending",
            timestamp: Date.now()
        })
            .then(() => {
                alert(`Exchange request for "${bookTitle}" sent successfully!`);
                const notificationMessage = `${requestedByName} requested an exchange for "${bookTitle}".`;
                addNotification(bookOwnerId, userId, bookKey, notificationMessage);
            })
            .catch((error) => {
                console.error("Error sending exchange request:", error);
                alert("Failed to send exchange request. Please try again.");
            });
    }).catch((error) => {
        console.error("Error fetching profile names:", error);
        alert("Failed to retrieve user information.");
    });
}

function generateUniqueID() {
    return "req_" + Math.random().toString(36).substr(2, 9);
}*/ 

window.handleExchangeRequest = function (bookID, userId) {
    if (!userId) {
        alert("You must be logged in to request an exchange.");
        return;
    }

    console.log("Requesting exchange for bookID:", bookID);

    const booksRef = ref(db, "books/");

    get(booksRef)
        .then((snapshot) => {
            if (!snapshot.exists()) {
                alert("No books found in the system.");
                return;
            }

            let foundBook = null;
            let bookKey = null;
            let bookOwnerId = null;

            snapshot.forEach((childSnapshot) => {
                const bookData = childSnapshot.val();
                if (bookData.id === bookID) {
                    foundBook = bookData;
                    bookKey = childSnapshot.key; // âœ… Get the Firebase book ID
                    bookOwnerId = bookData.userid;
                }
            });

            if (!foundBook || !bookKey) {
                alert("Book not found in the system.");
                return;
            }

            if (!bookOwnerId) {
                alert("Error: Book owner not found.");
                return;
            }

            if (bookOwnerId === userId) {
                alert("You cannot exchange your own book.");
                return;
            }

            if (!foundBook.status || foundBook.status.toLowerCase() !== "available") {
                alert(`Sorry, "${foundBook.title}" is currently unavailable for exchange.`);
                return;
            }

            // âœ… Check if a pending request already exists
            checkExistingRequestBeforeCreating(bookKey, bookOwnerId, userId, foundBook.title);
        })
        .catch((error) => {
            console.error("Error fetching books:", error);
            alert("Failed to fetch book information.");
        });
};

function checkExistingRequestBeforeCreating(bookKey, bookOwnerId, userId, bookTitle) {
    const exchangeRequestsRef = ref(db, "exchange_requests");

    get(exchangeRequestsRef)
        .then((snapshot) => {
            if (snapshot.exists()) {
                const requests = snapshot.val();

                console.log("ðŸ”¥ Checking existing exchange requests:", requests);

                const hasPendingRequest = Object.values(requests).some(request => {
                    return (
                        request.bookRequested === bookKey &&
                        request.userId === userId &&
                        request.status.toLowerCase() === "pending"
                    );
                });

                if (hasPendingRequest) {
                    alert("â³ You have already requested this book. Waiting for owner's approval.");
                    return;
                }
            }

            // âœ… No pending request, proceed with exchange request
            createExchangeRequest(bookKey, bookOwnerId, userId, bookTitle);
        })
        .catch((error) => {
            console.error("âŒ Error checking existing requests:", error);
            alert("Failed to check existing exchange requests.");
        });
}

function createExchangeRequest(bookKey, bookOwnerId, userId, bookTitle) {
    const requestID = generateUniqueID();

    Promise.all([
        get(ref(db, `profiles/${userId}`)), // Requester's profile
        get(ref(db, `profiles/${bookOwnerId}`)) // Book owner's profile
    ]).then(([requestedBySnap, requestedToSnap]) => {
        const requestedByName = requestedBySnap.exists() ? requestedBySnap.val().name : "Unknown User";
        const requestedToName = requestedToSnap.exists() ? requestedToSnap.val().name : "Unknown User";

        const exchangeRef = ref(db, `exchange_requests/${requestID}`);

        set(exchangeRef, {
            requestID: requestID,
            userId: userId, // âœ… Store requester's user ID
            ownerId: bookOwnerId,
            requestedBy: requestedByName, // âœ… Store requester's name
            bookRequested: bookKey, // âœ… Store Firebase book ID
            requestedTo: requestedToName,
            status: "pending",
            bookHandover: "pending",
            bookReturn: "pending",
            timestamp: Date.now()
        })
            .then(() => {
                alert(`ðŸ“Œ Exchange request for "${bookTitle}" sent successfully!`);
                const notificationMessage = `${requestedByName} requested an exchange for "${bookTitle}".`;
                addNotification(bookOwnerId, userId, bookKey, notificationMessage);
            })
            .catch((error) => {
                console.error("âŒ Error sending exchange request:", error);
                alert("Failed to send exchange request. Please try again.");
            });
    }).catch((error) => {
        console.error("âŒ Error fetching profile names:", error);
        alert("Failed to retrieve user information.");
    });
}

function generateUniqueID() {
    return "req_" + Math.random().toString(36).substr(2, 9);
}


window.removeFromWishlist = function (bookKey) {
    const bookRef = ref(db, `wishlist/${userId}/${bookKey}`);
    remove(bookRef)
        .then(() => {
            alert("Book removed from wishlist!");
        })
        .catch((error) => {
            console.error("Error removing book:", error);
        });
};

loadWishlist();


    </script>
    
</body>
</html>
